<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SKY NOR â€“ Ø§Ù„ØµØ­Ù† Ø§Ù„Ø·Ø§Ø¦Ø± Ø¹Ù„Ù‰ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©</title>

  <!-- Leaflet CDN -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <!-- Favicon (SVG) -->
  <link rel="icon" href='data:image/svg+xml;utf8,
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
    <defs><radialGradient id="g" cx="50%" cy="70%" r="60%">
      <stop offset="0%" stop-color="#60a5fa" stop-opacity="0.9"/>
      <stop offset="100%" stop-color="#60a5fa" stop-opacity="0"/></radialGradient></defs>
    <rect width="64" height="64" rx="12" fill="#0b1220"/>
    <ellipse cx="32" cy="44" rx="16" ry="6" fill="url(#g)"/>
    <ellipse cx="32" cy="32" rx="22" ry="7" fill="#0ea5e9"/>
    <ellipse cx="32" cy="28" rx="12" ry="4" fill="#111827"/>
    <ellipse cx="32" cy="36" rx="18" ry="5" fill="#0b1220" stroke="#93c5fd" stroke-width="2"/>
  </svg>'/>

  <style>
    :root{
      --bg:#0b0f19; --panel:#0f172a; --panel2:#111827; --text:#e5e7eb; --muted:#94a3b8;
      --sea:#38bdf8; --land:#f59e0b; --trace:#22d3ee; --halo:#60a5fa;
      --rose:#f43f5e; --amber:#f59e0b; --emerald:#10b981; --sky:#0ea5e9;
    }
    *{box-sizing:border-box}
    body{margin:0;background:#0b0f19;color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial;line-height:1.7}
    header{max-width:1100px;margin:0 auto;padding:18px 14px;display:flex;gap:12px;align-items:center;justify-content:space-between}
    .brand{font-weight:700;font-size:clamp(18px,2.2vw,22px)}
    .chip{background:#0b1220;border:1px solid #1e293b;padding:6px 10px;border-radius:12px;font-size:13px}
    main{max-width:1100px;margin:0 auto;display:grid;gap:14px;padding:14px;grid-template-columns:1fr 340px}
    @media (max-width:980px){main{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.02));border:1px solid #1e293b;border-radius:16px;overflow:hidden}
    #map{height:64vh;min-height:480px}
    .panel{padding:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .select, .btn, .input{background:#0b1220;border:1px solid #223149;color:var(--text);padding:8px 10px;border-radius:10px}
    .btn{cursor:pointer;font-weight:600}
    .btn:active{transform:translateY(1px)}
    .btn-rose{background:var(--rose);border-color:var(--rose);color:#0b1220}
    .btn-amber{background:var(--amber);border-color:var(--amber);color:#0b1220}
    .btn-emerald{background:var(--emerald);border-color:var(--emerald);color:#0b1220}
    .btn-sky{background:var(--sky);border-color:var(--sky);color:#0b1220}
    .muted{color:var(--muted);font-size:13px}
    .counts{list-style:none;margin:8px 0 0;padding:0}
    .counts li{display:flex;justify-content:space-between;border-bottom:1px dashed #223149;padding:6px 2px}
    .counts li:last-child{border-bottom:none}
    .total{margin-top:8px;padding-top:8px;border-top:1px solid #223149;font-weight:700}
    footer{color:#8da0bf;text-align:center;padding:16px;font-size:12px}
    /* Leaflet dark tweak */
    .leaflet-control-attribution{background:#0b1220;color:#9fb3d9}
  </style>
</head>
<body>
  <header>
    <div class="brand">SKY NOR â€“ Ø§Ù„ØµØ­Ù† Ø§Ù„Ø·Ø§Ø¦Ø± Ø¹Ù„Ù‰ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©</div>
    <div class="chip">Ø¨Ø±Ø§Ø¡Ø© Ø§Ø®ØªØ±Ø§Ø¹: SA1020247498</div>
  </header>

  <main>
    <section class="card">
      <div id="map"></div>
      <div class="panel">
        <div class="row" style="justify-content:space-between">
          <div class="row">
            <button id="playBtn" class="btn">â¸ï¸ Ø¥ÙŠÙ‚Ø§Ù</button>
            <label>Ø§Ù„Ø³Ø±Ø¹Ø©:
              <select id="speedSel" class="select">
                <option value="0.5">Ã—0.5</option>
                <option value="1" selected>Ã—1</option>
                <option value="2">Ã—2</option>
                <option value="3">Ã—3</option>
              </select>
            </label>
            <label>Ø§Ù„Ù…Ø³Ø§Ø±:
              <select id="routeSel" class="select">
                <option value="coast">Ø§Ù„Ø³Ø§Ø­Ù„ÙŠ</option>
                <option value="land">Ø§Ù„Ø¨Ø±ÙŠ</option>
                <option value="full" selected>Ø§Ù„ÙƒØ§Ù…Ù„</option>
              </select>
            </label>
          </div>
          <div class="row">
            <span class="chip">Ø£Ø²Ø±Ù‚ Ø³Ø§Ø­Ù„</span>
            <span class="chip">Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ Ø¨Ø±Ù‘ÙŠ</span>
          </div>
        </div>
        <p class="muted">* Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª ØªÙ‚Ø±ÙŠØ¨ÙŠØ© Ù„Ù„Ø¹Ø±Ø¶. ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø¨Ø¨ÙŠØ§Ù†Ø§Øª GeoJSON Ø¯Ù‚ÙŠÙ‚Ø©.</p>
      </div>
    </section>

    <aside class="card">
      <div class="panel">
        <h3 style="margin:0 0 8px">Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚Ø§Ø±ÙŠØ± ÙÙˆØ±ÙŠØ©</h3>
        <div class="row" style="flex-wrap:wrap">
          <button class="btn btn-rose"   onclick="send('Ø§Ù„Ù‡Ù„Ø§Ù„ Ø§Ù„Ø£Ø­Ù…Ø±','rc')">ğŸš‘ Ø§Ù„Ù‡Ù„Ø§Ù„ Ø§Ù„Ø£Ø­Ù…Ø±</button>
          <button class="btn btn-amber"  onclick="send('Ø§Ù„Ù…Ø±ÙˆØ±','tr')">ğŸš“ Ø§Ù„Ù…Ø±ÙˆØ±</button>
          <button class="btn btn-emerald"onclick="send('Ø§Ù„Ø¯ÙØ§Ø¹ Ø§Ù„Ù…Ø¯Ù†ÙŠ','cd')">ğŸ§¯ Ø§Ù„Ø¯ÙØ§Ø¹ Ø§Ù„Ù…Ø¯Ù†ÙŠ</button>
          <button class="btn btn-sky"    onclick="send('Ø§Ù„Ø£Ø±ØµØ§Ø¯ Ø§Ù„Ø¬ÙˆÙŠØ©','met')">â˜ï¸ Ø§Ù„Ø£Ø±ØµØ§Ø¯ Ø§Ù„Ø¬ÙˆÙŠØ©</button>
          <button class="btn" style="margin-inline-start:auto" onclick="resetCounts()">ØªØµÙÙŠØ± Ø§Ù„Ø¹Ø¯Ù‘Ø§Ø¯Ø§Øª</button>
        </div>

        <h4 style="margin:14px 0 6px">Ø¹Ø¯Ù‘Ø§Ø¯ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</h4>
        <ul class="counts">
          <li><span>ğŸš‘ Ø§Ù„Ù‡Ù„Ø§Ù„ Ø§Ù„Ø£Ø­Ù…Ø±</span><b id="c-rc">0</b></li>
          <li><span>ğŸ§¯ Ø§Ù„Ø¯ÙØ§Ø¹ Ø§Ù„Ù…Ø¯Ù†ÙŠ</span><b id="c-cd">0</b></li>
          <li><span>ğŸš“ Ø§Ù„Ù…Ø±ÙˆØ±</span><b id="c-tr">0</b></li>
          <li><span>â˜ï¸ Ø§Ù„Ø£Ø±ØµØ§Ø¯ Ø§Ù„Ø¬ÙˆÙŠØ©</span><b id="c-met">0</b></li>
        </ul>
        <div class="total">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="c-total">0</span></div>
        <p class="muted">Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ ØªÙ†Ø¨ÙŠÙ‡ ØªØ¬Ø±ÙŠØ¨ÙŠ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ù‘Ø§Ø¯ Ù…Ø­Ù„ÙŠÙ‹Ø§. ÙŠÙ…ÙƒÙ† Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø±Ø¨Ø· Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø±Ù…Ø¬ÙŠØ© Ø­Ù‚ÙŠÙ‚ÙŠØ©.</p>
      </div>
    </aside>
  </main>

  <footer>Â© SKY NOR â€” Ø¨Ø±Ø§Ø¡Ø©: SA1020247498 â€” Ù†Ø³Ø®Ø© ØªÙˆØ¶ÙŠØ­ÙŠØ© Ø¹Ù„Ù‰ Ø®Ø±ÙŠØ·Ø© ÙØ¹Ù„ÙŠØ©</footer>

  <script>
    // -------- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª (ØªÙ‚Ø±ÙŠØ¨ÙŠØ©) --------
    const BORDER_PATH = [
      [31.0,41.1],[30.0,39.3],[29.4,37.0],[28.1,36.5],[27.3,35.2],
      [26.5,35.0],[25.0,36.0],[22.8,39.7],[20.8,41.8],[18.8,42.8],
      [17.6,43.1],[17.2,44.0],[17.4,47.0],[18.2,50.0],[19.6,52.0],
      [21.0,55.0],[24.0,55.6],[26.5,54.0],[28.0,49.5],[29.0,46.5],
      [29.5,44.5],[29.0,42.5],[27.8,41.8],[25.8,40.6],[24.0,39.9],
      [22.5,39.4],[21.0,39.0],[19.5,40.0],[18.0,41.0],[16.8,42.0],
      [16.4,42.6],[17.0,43.6],[18.0,44.2],[19.6,44.8],[21.5,45.0],
      [23.0,45.2],[24.5,45.3],[26.0,45.0],[27.5,44.2],[29.0,43.0],
      [31.0,41.1],
    ];
    const COAST_PATH = [
      [28.9,35.0],[27.5,35.4],[26.0,36.0],[24.8,37.0],[23.6,38.0],
      [22.0,39.2],[20.6,40.6],[19.4,41.6],[18.5,42.1],[17.6,42.6],
      [16.8,42.8],[16.6,43.4],[17.4,44.7],[18.8,45.6],[20.3,46.2],
    ];

    // -------- Ø£Ø¯ÙˆØ§Øª --------
    const clamp01 = x => x<0?0:x>1?1:x;
    const isTuple = v => Array.isArray(v) && v.length===2 &&
      Number.isFinite(v[0]) && Number.isFinite(v[1]);

    function validatePath(points){ return Array.isArray(points) && points.length>=2 && points.every(isTuple); }

    function interpOnPath(points,t){
      if(!validatePath(points)) return null;
      const seg = []; let total=0;
      for(let i=0;i<points.length-1;i++){
        const a=L.latLng(points[i][0],points[i][1]);
        const b=L.latLng(points[i+1][0],points[i+1][1]);
        const d=a.distanceTo(b); seg.push(d); total+=d;
      }
      if(total<=0) return points[0];
      let target = clamp01(t)*total;
      for(let i=0;i<seg.length;i++){
        if(target<=seg[i]){
          const r = seg[i]===0?0:target/seg[i];
          const a=points[i], b=points[i+1];
          return [ a[0]+(b[0]-a[0])*r, a[1]+(b[1]-a[1])*r ];
        }
        target -= seg[i];
      }
      return points[points.length-1];
    }

    // -------- Ø®Ø±ÙŠØ·Ø© --------
    const map = L.map('map', { zoomControl:true, attributionControl:true })
      .setView([23.7,44.6], 5);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      maxZoom: 18,
      attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    // Ù…Ø³Ø§Ø±Ø§Øª Ù…Ù„ÙˆÙ†Ø©
    const coastLine = L.polyline(COAST_PATH,{ color:'#38bdf8', weight:4, opacity:0.9, dashArray:'6 8' }).addTo(map);
    const landLine  = L.polyline(BORDER_PATH,{ color:'#f59e0b', weight:3, opacity:0.9, dashArray:'8 8' }).addTo(map);

    // Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØµØ­Ù† (SVG Ø¯Ø§Ø®Ù„ DivIcon)
    const saucerIcon = L.divIcon({
      className:'', iconSize:[60,36], iconAnchor:[30,18],
      html: `
        <div style="transform:translate(-50%, -50%);display:flex;align-items:center;justify-content:center;">
          <svg width="60" height="36" viewBox="0 0 120 72" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <radialGradient id="g" cx="50%" cy="60%" r="60%">
                <stop offset="0%" stop-color="#60a5fa" stop-opacity="0.9"/>
                <stop offset="100%" stop-color="#60a5fa" stop-opacity="0"/>
              </radialGradient>
            </defs>
            <ellipse cx="60" cy="54" rx="26" ry="10" fill="url(#g)"/>
            <ellipse cx="60" cy="36" rx="40" ry="12" fill="#0b1220" stroke="#93c5fd" stroke-width="2"/>
            <ellipse cx="60" cy="30" rx="22" ry="7" fill="#111827"/>
            <ellipse cx="60" cy="44" rx="18" ry="6" fill="#0ea5e9"/>
          </svg>
        </div>`
    });

    let routeKind = 'full'; // 'coast' | 'land' | 'full'
    const getActive = () => routeKind==='coast' ? COAST_PATH : routeKind==='land' ? BORDER_PATH : [...COAST_PATH, ...BORDER_PATH];

    let t = 0;
    let playing = true;
    let speed = 1;

    const marker = L.marker([23.7,44.6], { icon:saucerIcon }).addTo(map);
    const halo = L.circleMarker([23.7,44.6], { radius:14, color:'#60a5fa', fillOpacity:0.12 }).addTo(map);

    function tick(now){
      if(playing){
        t = (t + 0.0015 * speed) % 1; // Ø³Ø±Ø¹Ø© Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ø®Ø±ÙŠØ·Ø©
        const pos = interpOnPath(getActive(), t);
        if(isTuple(pos)){
          marker.setLatLng(pos);
          halo.setLatLng(pos);
        }
      }
      requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);

    // Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ…
    const playBtn  = document.getElementById('playBtn');
    const speedSel = document.getElementById('speedSel');
    const routeSel = document.getElementById('routeSel');

    playBtn.addEventListener('click', ()=>{
      playing = !playing;
      playBtn.textContent = playing ? 'â¸ï¸ Ø¥ÙŠÙ‚Ø§Ù' : 'â–¶ï¸ ØªØ´ØºÙŠÙ„';
    });
    speedSel.addEventListener('change', e => {
      const v = parseFloat(e.target.value);
      speed = Number.isFinite(v) ? v : 1;
    });
    routeSel.addEventListener('change', e => {
      routeKind = e.target.value;
    });

    // -------- ØªÙ‚Ø§Ø±ÙŠØ± + Ø¹Ø¯Ù‘Ø§Ø¯Ø§Øª --------
    const counters = { rc:0, cd:0, tr:0, met:0 };
    function updateCounts(){
      document.getElementById('c-rc').textContent  = counters.rc;
      document.getElementById('c-cd').textContent  = counters.cd;
      document.getElementById('c-tr').textContent  = counters.tr;
      document.getElementById('c-met').textContent = counters.met;
      document.getElementById('c-total').textContent = counters.rc + counters.cd + counters.tr + counters.met;
    }
    window.resetCounts = function(){
      counters.rc = counters.cd = counters.tr = counters.met = 0;
      updateCounts();
    }
    window.send = function(agencyLabel, key){
      const pos = isTuple(marker.getLatLng()) ? marker.getLatLng() : null;
      counters[key]++; updateCounts();
      alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚Ø±ÙŠØ± ØªØ¬Ø±ÙŠØ¨ÙŠ Ø¥Ù„Ù‰: ' + agencyLabel + (pos ? `\nØ§Ù„Ù…ÙˆÙ‚Ø¹: (${pos.lat.toFixed(4)}, ${pos.lng.toFixed(4)})` : ''));
      // Ù…Ù„Ø§Ø­Ø¸Ø©: ÙŠÙ…ÙƒÙ† Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ù‡Ø°Ø§ Ø¨Ù€ fetch('/api/report', {method:'POST', body:...})
    }
    updateCounts();
  </script>
</body>
</html>

